### Data scraping from TSN Player Bio's (OLD - DIDN'T SCRAPE ALL DATA IN 1ST CODE CHUNK)

```{r, messages=FALSE, warning=FALSE}
library(jsonlite)
library(ggplot2)

# Penguin Players First
Pens.roster <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Penguin-Roster-JSON")
Pens.roster.names <- Pens.roster$LastName

# extract all players' jsons, add first and last names
astonreese.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Aston-Reese-JSON")
astonreese.first = rep("Zach", nrow(astonreese.jsontable))
astonreese.jsontable$firstname = astonreese.first
astonreese.last = rep("Aston-Reese", nrow(astonreese.jsontable))
astonreese.jsontable$lastname = astonreese.last

brassard.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Brassard-JSON")
brassard.first = rep("Derick", nrow(brassard.jsontable))
brassard.jsontable$firstname = brassard.first
brassard.last = rep("Brassard", nrow(brassard.jsontable))
brassard.jsontable$lastname = brassard.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
brassard.jsontable = brassard.jsontable[-c(1,4,11,12,13,18,21,28,31,32,33,34,35), ]

cole.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Cole-JSON")
cole.first = rep("Ian", nrow(cole.jsontable))
cole.jsontable$firstname = cole.first
cole.last = rep("Cole", nrow(cole.jsontable))
cole.jsontable$lastname = cole.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
cole.jsontable = cole.jsontable[c(2,3,6,7,17,18), ]

crosby.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Crosby-JSON")
crosby.first = rep("Sidney", nrow(crosby.jsontable))
crosby.jsontable$firstname = crosby.first
crosby.last = rep("Crosby", nrow(crosby.jsontable))
crosby.jsontable$lastname = crosby.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
crosby.jsontable = crosby.jsontable[-c(17, 37,42),]

dumoulin.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Dumoulin-JSON")
dumoulin.first = rep("Brian", nrow(dumoulin.jsontable))
dumoulin.jsontable$firstname = dumoulin.first
dumoulin.last = rep("Dumoulin", nrow(dumoulin.jsontable))
dumoulin.jsontable$lastname = dumoulin.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
dumoulin.jsontable = dumoulin.jsontable[c(1,2,6,7,8,9),]

guentzel.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Guentzel-JSON")
guentzel.first = rep("Jake", nrow(guentzel.jsontable))
guentzel.jsontable$firstname = guentzel.first
guentzel.last = rep("Guentzel", nrow(guentzel.jsontable))
guentzel.jsontable$lastname = guentzel.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
guentzel.jsontable = guentzel.jsontable[c(1,2),]


hagelin.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Hagelin-JSON")
hagelin.first = rep("Carl", nrow(hagelin.jsontable))
hagelin.jsontable$firstname = hagelin.first
hagelin.last = rep("Hagelin", nrow(hagelin.jsontable))
hagelin.jsontable$lastname = hagelin.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
hagelin.jsontable = hagelin.jsontable[-c(12,13,14,17,18,19,22,23,24,25),]

hornqvist.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Hornqvist-JSON")
hornqvist.first = rep("Patric", nrow(hornqvist.jsontable))
hornqvist.jsontable$firstname = hornqvist.first
hornqvist.last = rep("Hornqvist", nrow(hornqvist.jsontable))
hornqvist.jsontable$lastname = hornqvist.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
hornqvist.jsontable = hornqvist.jsontable[-c(21,28,37,38,39,47,52,53,54,55,56,57,58),]

hunwick.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Hunwick-JSON")
hunwick.first = rep("Matt", nrow(hunwick.jsontable))
hunwick.jsontable$firstname = hunwick.first
hunwick.last = rep("Hunwick", nrow(hunwick.jsontable))
hunwick.jsontable$lastname = hunwick.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
hunwick.jsontable = hunwick.jsontable[-c(7,17,20,21,22,23,24,25,28,29,32,33,36,37,seq(40,51)),]


jarry.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Jarry-JSON")
jarry.first = rep("Tristan", nrow(jarry.jsontable))
jarry.jsontable$firstname = jarry.first
jarry.last = rep("Jarry", nrow(jarry.jsontable))
jarry.jsontable$lastname = jarry.last


kessel.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Kessel-JSON")
kessel.first = rep("Phil", nrow(kessel.jsontable))
kessel.jsontable$firstname = kessel.first
kessel.last = rep("Kessel", nrow(kessel.jsontable))
kessel.jsontable$lastname = kessel.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
kessel.jsontable = kessel.jsontable[-c(1,2,4,5,13,14,16),]

letang.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Letang-JSON")
letang.first = rep("Kris", nrow(letang.jsontable))
letang.jsontable$firstname = letang.first
letang.last = rep("Letang", nrow(letang.jsontable))
letang.jsontable$lastname = letang.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
letang.jsontable = letang.jsontable[-c(40,51,61,seq(71,74)),]

maatta.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Maatta-JSON")
maatta.first = rep("Olli", nrow(maatta.jsontable))
maatta.jsontable$firstname = maatta.first
maatta.last = rep("Maatta", nrow(maatta.jsontable))
maatta.jsontable$lastname = maatta.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
maatta.jsontable = maatta.jsontable[-c(9,12,13,seq(21,23)),]

malkin.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Murray-JSON")
malkin.first = rep("Evgeni", nrow(malkin.jsontable))
malkin.jsontable$firstname = malkin.first
malkin.last = rep("Malkin", nrow(malkin.jsontable))
malkin.jsontable$lastname = malkin.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
malkin.jsontable = malkin.jsontable[-c(12,seq(17,27)),]


murray.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Murray-JSON")
murray.first = rep("Matt", nrow(murray.jsontable))
murray.jsontable$firstname = murray.first
murray.last = rep("Murray", nrow(murray.jsontable))
murray.jsontable$lastname = murray.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
murray.jsontable = murray.jsontable[-c(12,seq(17,27)),]


oleksiak.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Oleksiak-JSON")
oleksiak.first = rep("Jamie", nrow(oleksiak.jsontable))
oleksiak.jsontable$firstname = oleksiak.first
oleksiak.last = rep("Oleksiak", nrow(oleksiak.jsontable))
oleksiak.jsontable$lastname = oleksiak.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
oleksiak.jsontable = oleksiak.jsontable[-c(seq(1,3), seq(13,38)),]


reaves.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Reaves-JSON")
reaves.first = rep("Ryan", nrow(reaves.jsontable))
reaves.jsontable$firstname = reaves.first
reaves.last = rep("Reaves", nrow(reaves.jsontable))
reaves.jsontable$lastname = reaves.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
reaves.jsontable = reaves.jsontable[-c(1,8,12,13,seq(18,36)),]


rowney.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Rowney-JSON")
rowney.first = rep("Carter", nrow(rowney.jsontable))
rowney.jsontable$firstname = rowney.first
rowney.last = rep("Rowney", nrow(rowney.jsontable))
rowney.jsontable$lastname = rowney.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
rowney.jsontable = rowney.jsontable[-c(seq(7,12)),]

ruhwedel.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Ruhwedel-JSON")
ruhwedel.first = rep("Chad", nrow(ruhwedel.jsontable))
ruhwedel.jsontable$firstname = ruhwedel.first
ruhwedel.last = rep("Ruhwedel", nrow(ruhwedel.jsontable))
ruhwedel.jsontable$lastname = ruhwedel.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
ruhwedel.jsontable = ruhwedel.jsontable[-c(3,10,11,seq(14,31), seq(34,40)),]

rust.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Rust-JSON")
rust.first = rep("Bryan", nrow(rust.jsontable))
rust.jsontable$firstname = rust.first
rust.last = rep("Rust", nrow(rust.jsontable))
rust.jsontable$lastname = rust.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
rust.jsontable = rust.jsontable[-c(seq(12,15),17,seq(20,29)),]


schultz.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Schultz-JSON")
schultz.first = rep("Justin", nrow(schultz.jsontable))
schultz.jsontable$firstname = schultz.first
schultz.last = rep("Schultz", nrow(schultz.jsontable))
schultz.jsontable$lastname = schultz.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
schultz.jsontable = schultz.jsontable[-c(6,7,seq(12,14),17,seq(20,22), seq(26,28)),]

sheahan.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Sheahan-JSON")
sheahan.first = rep("Riley", nrow(sheahan.jsontable))
sheahan.jsontable$firstname = sheahan.first
sheahan.last = rep("Sheahan", nrow(sheahan.jsontable))
sheahan.jsontable$lastname = sheahan.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
sheahan.jsontable = sheahan.jsontable[-c(1,4,seq(9,27)),]


sheary.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Sheary-JSON")
sheary.first = rep("Conor", nrow(sheary.jsontable))
sheary.jsontable$firstname = sheary.first
sheary.last = rep("Sheary", nrow(sheary.jsontable))
sheary.jsontable$lastname = sheary.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
sheary.jsontable = sheary.jsontable[-c(seq(4,6), seq(15,28)),]

simon.jsontable <- fromJSON("~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data/Simon-JSON")
simon.first = rep("Dominik", nrow(simon.jsontable))
simon.jsontable$firstname = simon.first
simon.last = rep("Simon", nrow(simon.jsontable))
simon.jsontable$lastname = simon.last
# delete irrelevant non-injury data (ie. acquisitions, negotiations, etc.)
simon.jsontable = simon.jsontable[c(3,4),]


# merge all players' injury tables
# not including becuase no injury data: astonreese, jarry
# note: did not remove suspension/fines entries yet
player.table = rbind(brassard.jsontable,cole.jsontable, crosby.jsontable, dumoulin.jsontable, guentzel.jsontable, hagelin.jsontable,hornqvist.jsontable,  hunwick.jsontable, kessel.jsontable, letang.jsontable,maatta.jsontable, malkin.jsontable,  murray.jsontable, oleksiak.jsontable, reaves.jsontable, rowney.jsontable, ruhwedel.jsontable,rust.jsontable,  schultz.jsontable, sheahan.jsontable, sheary.jsontable, simon.jsontable)

# split date string into something usable
player.table$year = substr(player.table$Date, 1, 4)
player.table$month = substr(player.table$Date, 6, 7)
player.table$day = substr(player.table$Date, 9,10)

# get number of missed games
games_missing = c()
pattern="Missed (.*?) game"
for (i in 1:nrow(player.table)){
  gm = regmatches(player.table$Desc, regexec(pattern,player.table$Desc))[[i]][2]
  games_missing = c(games_missing, gm)
}


# clean up edge cases
games_missing[9] = 2
games_missing[21] = 54
games_missing[30] = 1
games_missing[44] = 13
games_missing[51] = 41
games_missing[77] = 2
games_missing[79] = 22
games_missing[100] = 6
games_missing[118] = 6
games_missing[133] = 4
games_missing[146] = 17
games_missing[156] = 3
games_missing[158] = 10
games_missing[174] = 48
games_missing[195] = 12
games_missing[231] = 1
games_missing[243] = 3
games_missing[245] = 9
games_missing[249] = 61
games_missing[262] = 11
games_missing[269] = 2
games_missing[277] = 11
games_missing[284] = 2
games_missing[316] = 6
games_missing[318] = 10
games_missing[324] = 4
games_missing[328] = 2
games_missing[335] = 7
games_missing[345] = 4
games_missing[365] = 1
gm = as.integer(games_missing)

# add games missed to player data
player.table$games.missed = gm

# get injury
injury = c()
pattern="(.*?),"
for (i in 1:nrow(player.table)){
  inj = regmatches(player.table$Desc, regexec(pattern,player.table$Desc))[[i]][2]
  injury = c(injury, inj)
}


player.table$injury = injury

# remove those with suspensions
regex = grepl("uspen", player.table$Desc)
player.table = subset(player.table, regex==FALSE)

index = c()
for (a in 1:nrow(player.table)){
  index = c(index, a)
}
player.table$index = index


player.table = player.table[-c(23,24,25,46,51,79,80,90,91,118,121,124,141,166,169,172,177,186,195,198,201,210,213,220,229,230,232,231,243,260,275,282,285,286,291,298,301,320,327,328,339,340,343,352,359,360),]
player.table$index = NULL


# index = c()
# for (a in 1:nrow(player.table)){
#   index = c(index, a)
# }
# player.table$index = index

nrow(player.table)
for (count in 1:nrow(player.table)/2){
  player.table$injury[2*count - 1] = player.table$injury[2*count]
}
player.table = player.table[-c(53,76),]

player.table = player.table[-seq(2,316,by=2),]
player.table$injury[player.table$injury == "Post concussion"] = "Concussion"
player.table$injury[player.table$injury == "Broken right hand"] = "Broken hand"
player.table$injury[player.table$injury == "Left hand injury"] = "Broken hand"
player.table$injury[player.table$injury == "Right ankle injury"] = "Ankle injury"
player.table$injury[player.table$injury == "Left shoulder surgery"] = "Shoulder surgery"
player.table$injury[player.table$injury == "Sprained right ankle"] = "Ankle injury"
player.table$injury[player.table$injury == "Bruised right shoulder"] = "Shoulder injury"

ggplot(player.table) + 
  geom_bar(aes(x=injury))   + theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title="Frequency of Pittsburgh Penguins Players' Injuries", x = "Injury Type", y="Frequency")
ggplot(player.table) + 
  geom_bar(aes(x=year), fill="#57a0ff")   + theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title="Frequency of Penguins Players' Injuries by Year", x = "Year", y="Frequency")

write.csv(player.table, file = "~/Desktop/CMU/36-490/NHL-Research/Combined-Data/Pens-Combined.csv")

inj = c()
for (x in min(player.table$year):max(player.table$year)){
  inj = c(inj,length(player.table[player.table$year == x, "lastname"]))
}
players_per_year = c(1,1,1,5,6,7,7,9,11,14,19,20, 20)
years = seq(min(player.table$year),max(player.table$year))
ggplot() + geom_point(aes(x = years, y = inj / players_per_year)) + 
  labs(title="Average Number of Penguins Players' Injuries by Year", x = "Year", y = "Injuries per Year") 

```



```{r message=FALSE, warning=FALSE}


Avalanche = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Avalanche-Data"
Blackhawks = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Blackhawks-Data"
BlueJackets = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/BlueJackets-Data"
Blues = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Blues-Data"
Bruins = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Bruins-Data"
Canadiens = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Canadiens-Data"
Canucks = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Canucks-Data"
Capitals = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Capitals-Data"
Coyotes = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Coyotes-Data"
Devils = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Devils-Data"
Ducks = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Ducks-Data"
Flames = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Flames-Data"
Flyers = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Flyers-Data"
GoldenKnights = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/GoldenKnights-Data"
Hurricanes = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Hurricanes-Data"
Islanders = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Islanders-Data"
Jets = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Jets-Data"
Kings = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Kings-Data"
Lightning = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Lightning-Data"
MapleLeafs = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/MapleLeafs-Data"
Oilers = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Oilers-Data"
Panthers = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Panthers-Data"
Penguins = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Penguins-Data"
Predators = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Predators-Data"
Rangers = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Rangers-Data"
RedWings = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/RedWings-Data"
Sabres = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Sabres-Data"
Senators = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Senators-Data"
Sharks = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Sharks-Data"
Stars = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Stars-Data"
Wild = "~/Desktop/CMU/36-490/NHL-Research/Player-Data/Wild-Data"

library(dplyr)
multmerge = function(path){
  filenames=list.files(path=path, full.names=TRUE)
  rbind_list(lapply(filenames, read.csv))
}

AvalancheData = multmerge(Avalanche)
BlackhawksData=multmerge(Blackhawks)
BlueJacketsData=multmerge(BlueJackets)
BluesData=multmerge(Blues)
BruinsData=multmerge(Bruins)
CanadiensData=multmerge(Canadiens)
CanucksData=multmerge(Canucks)
CapitalsData=multmerge(Capitals)
CoyotesData=multmerge(Coyotes)
FlyersData=multmerge(Flyers)
DevilsData=multmerge(Devils)
FlamesData=multmerge(Flames)
DucksData=multmerge(Ducks)
GoldenKnightsData=multmerge(GoldenKnights)
HurricanesData=multmerge(Hurricanes)
IslandersData=multmerge(Islanders)
JetsData=multmerge(Jets)
KingsData=multmerge(Kings)
LightningData=multmerge(Lightning)
MapleLeafsData=multmerge(MapleLeafs)
OilersData=multmerge(Oilers)
PanthersData=multmerge(Panthers)
PenguinsData=multmerge(Penguins)
PredatorsData=multmerge(Predators)
RangersData=multmerge(Rangers)
RedWingsData=multmerge(RedWings)
SabresData=multmerge(Sabres)
SenatorsData=multmerge(Senators)
SharksData=multmerge(Sharks)
StarsData=multmerge(Stars)
WildData=multmerge(Wild)
```

```{r message=FALSE, warning=FALSE, fig.height=11, fig.width = 9}

nhl.data = AvalancheData
nhl.data = merge(nhl.data, BlackhawksData, all=TRUE)
nhl.data = merge(nhl.data, BlueJacketsData, all=TRUE)
nhl.data = merge(nhl.data, BluesData, all=TRUE)
nhl.data = merge(nhl.data, BruinsData, all=TRUE)
nhl.data = merge(nhl.data, CanadiensData, all=TRUE)
nhl.data = merge(nhl.data, CanucksData, all=TRUE)
nhl.data = merge(nhl.data, CapitalsData, all=TRUE)
nhl.data = merge(nhl.data, CoyotesData, all=TRUE)
nhl.data = merge(nhl.data, DevilsData, all=TRUE)
nhl.data = merge(nhl.data, DucksData, all=TRUE)
nhl.data = merge(nhl.data, FlyersData, all=TRUE)
nhl.data = merge(nhl.data, GoldenKnightsData, all=TRUE)
nhl.data = merge(nhl.data, HurricanesData, all=TRUE)
nhl.data = merge(nhl.data, IslandersData, all=TRUE)
nhl.data = merge(nhl.data, JetsData, all=TRUE)
nhl.data = merge(nhl.data, KingsData, all=TRUE)
nhl.data = merge(nhl.data, LightningData, all=TRUE)
nhl.data = merge(nhl.data, MapleLeafsData, all=TRUE)
nhl.data = merge(nhl.data, OilersData, all=TRUE)
nhl.data = merge(nhl.data, PanthersData, all=TRUE)
nhl.data = merge(nhl.data, PenguinsData, all=TRUE)
nhl.data = merge(nhl.data, PredatorsData, all=TRUE)
nhl.data = merge(nhl.data, RangersData, all=TRUE)
nhl.data = merge(nhl.data, RedWingsData, all=TRUE)
nhl.data = merge(nhl.data, SabresData, all=TRUE)
nhl.data = merge(nhl.data, SenatorsData, all=TRUE)
nhl.data = merge(nhl.data, SharksData, all=TRUE)
nhl.data = merge(nhl.data, StarsData, all=TRUE)
nhl.data = merge(nhl.data, WildData, all=TRUE)


# get date info from string
nhl.data$year = substr(nhl.data$Date, 9, 12)
month = substr(nhl.data$Date, 1, 3)
months <- c("Jan","Feb","Mar",
              "Apr","May","Jun",
              "Jul","Aug","Sep",
              "Oct","Nov","Dec")

for (mon in 1:length(months)){
  month = replace(month, month==months[mon], mon)

}
nhl.data$month = as.integer(month)
nhl.data$day = substr(nhl.data$Date, 5,6)

# calculate number of injury games

Numextract <- function(string){
  unlist(regmatches(string,gregexpr("[[:digit:]]+\\.*[[:digit:]]*",string)))
}

for (i in 1:nrow(nhl.data)){
  nhl.data$games.injured[i] = sum(as.numeric(Numextract(nhl.data$Injury[i])))

}

# change the names of all the team names that were parsed incorrectly
city = nhl.data$City
city = gsub("ST", "ST. LOUIS", city)
city = gsub("SAN", "SAN JOSE", city)
city = gsub("BOST. LOUISON", "BOSTON", city)
city = gsub("NEW", "NEW YORK", city)
city = gsub("TAMPA", "TAMPA BAY", city)
city = gsub("LOS", "LOS ANGELES", city)
nhl.data$City = city

teamname = nhl.data$TeamName
teamname = gsub("YORKRANGERS", "RANGERS", teamname)
teamname = gsub("YORKISLANDERS", "ISLANDERS", teamname)
teamname = gsub("JOSESHARKS", "SHARKS", teamname)
teamname = gsub("LOUISBLUES", "BLUES", teamname)
teamname = gsub("ANGELESKINGS", "KINGS", teamname)
teamname = gsub("BAYLIGHTNING", "LIGHTNING", teamname)
nhl.data$TeamName = teamname



nhl.data = nhl.data[-grep("uspen|fined|Fined|igned|called|eturned|waiver|cq|offer|team|Team|oaned|isciplin|elect|elease|alary", nhl.data$Injury),]
nhl.data = nhl.data[order(nhl.data$Team, nhl.data$Lastname, nhl.data$year, nhl.data$month, nhl.data$day),]
# 
# get injury type from the "Missed (n) games (injury type)"
pattern="(.*?),"
nhl.data$MissedGamesListing = grepl("Missed ", nhl.data$Injury)

  library(stringr)
nhl.data$InjuryType = sapply(unlist(nhl.data$Injury), function(j) gsub("[\\(\\)]", "", regmatches(j, gregexpr("\\(.*?\\)", j))[[1]]))
nhl.data$InjuryType = lapply(nhl.data$InjuryType, function(x) if(identical(x, character(0))) NA_character_ else x)

nhl.data$SeasonEnding = grepl("Missed the last", nhl.data$Injury)


nhl.data$Index = seq(1,nrow(nhl.data))

# test = 0
# duplicate.missed = rep(FALSE, nrow(nhl.data) - 1)
# for(i in 1:nrow(nhl.data)){
#   if(nhl.data$MissedGamesListing[i] == TRUE && nhl.data$NextMissed1[i] == TRUE){
#     duplicate.missed[i] = TRUE
#     test = test + 1
#     print(i)
# 
#   }
# }



# delete missed entries that dont have another row which states start of injury date or are extraineous
nhl.data = nhl.data[-c(127, 1753, 1848,1849, 1962, 2305, 2306, 2668, 2788, seq(3111,3114), 3324, 3394,3395, 5265,5266, 5401,5402, 5450, 5777, 7052, 7506,7507, 7552, 8052, 8076),]


# delete training camp entries
nhl.data = nhl.data[-grep("training camp", nhl.data$Injury),]

for(i in 1:nrow(nhl.data)){
  nhl.data$Index[i] = i
}



# duplicate.missed = rep(FALSE, nrow(nhl.data) - 1)
# for(i in 1:nrow(nhl.data)){
#   if(nhl.data$MissedGamesListing[i] == TRUE && nhl.data$NextMissed1[i] == TRUE){
#     duplicate.missed[i] = TRUE
#     test = test + 1
#     print(i)
# 
#   }
# }

# additional duplicate response deleted
nhl.data = nhl.data[-5361,]

delete.duplicate = rep(0,nrow(nhl.data))
for(i in 1:nrow(nhl.data)){
  # check if current data point is a missed game listing
  if(delete.duplicate[i] != 0){
    next
  }
  # skip if line is Missed line
  if(nhl.data$MissedGamesListing[i] == TRUE){
    next
  }
  # delete duplicate litings since we just want start injury date (these are not Missed lines)
  else{
    next.entry = i+1
    while(nhl.data$MissedGamesListing[next.entry] == FALSE){
      delete.duplicate[next.entry] = 1
      next.entry = next.entry + 1
    }
  }
}
nhl.data$delete.duplicate = delete.duplicate


nhl.data = nhl.data[-which(delete.duplicate != 0),]



for(i in 1:nrow(nhl.data)){
  nhl.data$Index[i] = i
}

nhl.data$MissedGamesListing = grepl("Missed ", nhl.data$Injury)
# 
# duplicate.missed = rep(FALSE, nrow(nhl.data) - 1)
# for(i in 1:nrow(nhl.data)){
#   if(nhl.data$MissedGamesListing[i] == TRUE && nhl.data$NextMissed1[i] == TRUE){
#     duplicate.missed[i] = TRUE
#     test = test + 1
#     print(i)
# 
#   }
# }


# reparse the start injury dates
injend.month = nhl.data$month
injend.day = nhl.data$day
injend.year = nhl.data$year
injstart.month = nhl.data$month
injstart.day = nhl.data$day
injstart.year = nhl.data$year


for(i in seq(from=2, to=nrow(nhl.data), by=2)){
  injstart.month[i] = injstart.month[i-1]
  injstart.day[i] = injstart.day[i-1]
  injstart.year[i] = injstart.year[i-1]
}

# replace with correct date entries
# nhl.data$month = NULL
# nhl.data$day = NULL
# nhl.data$year = NULL

nhl.data$injstart.month = injstart.month
nhl.data$injstart.day = injstart.day
nhl.data$injstart.year = injstart.year
nhl.data$injend.month = injend.month
nhl.data$injend.day = injend.day
nhl.data$injend.year = injend.year

# edge cases parsing on year


for(i in 1:nrow(nhl.data.clean1)){
  nhl.data.clean1$Index[i] = i
}


nhl.data.clean1 = nhl.data[seq(2,nrow(nhl.data), by=2),]

nhl.data.clean1$injstart.month[1] = 1
nhl.data.clean1$injstart.day[1] = 11
nhl.data.clean1$injstart.year[1] = 2014

nhl.data.clean1$injstart.month[40] = 10
nhl.data.clean1$injstart.day[40] = 13
nhl.data.clean1$injstart.year[40] = 2017

nhl.data.clean1$injstart.month[168] = 3
nhl.data.clean1$injstart.day[168] = 17
nhl.data.clean1$injstart.year[168] = 2014

nhl.data.clean1$injstart.month[208] = 1
nhl.data.clean1$injstart.day[208] = 24
nhl.data.clean1$injstart.year[208] = 2013

nhl.data.clean1$injstart.month[347] = 4
nhl.data.clean1$injstart.day[347] = 3
nhl.data.clean1$injstart.year[347] = 2017

nhl.data.clean1$injstart.month[536] = 4
nhl.data.clean1$injstart.day[536] = 10
nhl.data.clean1$injstart.year[536] = 2017

nhl.data.clean1$injstart.month[536] = 4
nhl.data.clean1$injstart.day[536] = 10
nhl.data.clean1$injstart.year[536] = 2017


nhl.data.clean1$injstart.month[740] = 10
nhl.data.clean1$injstart.day[740] = 3
nhl.data.clean1$injstart.year[740] = 2017

nhl.data.clean1$injstart.month[743] = 2
nhl.data.clean1$injstart.day[743] = 3
nhl.data.clean1$injstart.year[743] = 2010


nhl.data.clean1$injstart.month[754-1] = 4
nhl.data.clean1$injstart.day[754-1] = 1
nhl.data.clean1$injstart.year[754-1] = 2012

nhl.data.clean1$injstart.month[825-1] = 3
nhl.data.clean1$injstart.day[825-1] = 9
nhl.data.clean1$injstart.year[825-1] = 2017

nhl.data.clean1$injstart.month[1115-1] = 4
nhl.data.clean1$injstart.day[1115-1] = 5
nhl.data.clean1$injstart.year[1115-1] = 2007

nhl.data.clean1$injstart.month[1184-1] = 11
nhl.data.clean1$injstart.day[1184-1] = 4
nhl.data.clean1$injstart.year[1184-1] = 2014

nhl.data.clean1$injstart.month[1283-1] = 12
nhl.data.clean1$injstart.day[1283-1] = 19
nhl.data.clean1$injstart.year[1283-1] = 2011

nhl.data.clean1$injstart.month[1433-1] = 12
nhl.data.clean1$injstart.day[1433-1] = 5
nhl.data.clean1$injstart.year[1433-1] = 2016

nhl.data.clean1$injstart.month[1468-1] = 1
nhl.data.clean1$injstart.day[1468-1] = 8
nhl.data.clean1$injstart.year[1468-1] = 2018

nhl.data.clean1$injstart.month[1493-1] = 3
nhl.data.clean1$injstart.day[1493-1] = 2
nhl.data.clean1$injstart.year[1493-1] = 2016

nhl.data.clean1$injstart.month[1494-1] = 12
nhl.data.clean1$injstart.day[1494-1] = 28
nhl.data.clean1$injstart.year[1494-1] = 2016

nhl.data.clean1$injstart.month[1523-1] = 1
nhl.data.clean1$injstart.day[1523-1] = 15
nhl.data.clean1$injstart.year[1523-1] = 2016

nhl.data.clean1$injstart.month[1636-1] = 10
nhl.data.clean1$injstart.day[1636-1] = 13
nhl.data.clean1$injstart.year[1636-1] = 2009


nhl.data.clean1$injstart.month[1678-1] = 2
nhl.data.clean1$injstart.day[1678-1] = 5
nhl.data.clean1$injstart.year[1678-1] = 2018

nhl.data.clean1$injstart.month[1940-1] = 10
nhl.data.clean1$injstart.day[1940-1] = 27
nhl.data.clean1$injstart.year[1940-1] = 2009

nhl.data.clean1$injstart.month[2143-1] = 11
nhl.data.clean1$injstart.day[2143-1] = 3
nhl.data.clean1$injstart.year[2143-1] = 2016

nhl.data.clean1$injstart.month[2263-1] = 11
nhl.data.clean1$injstart.day[2263-1] = 12
nhl.data.clean1$injstart.year[2263-1] = 2006

nhl.data.clean1$injstart.month[2289-1] = 3
nhl.data.clean1$injstart.day[2289-1] = 14
nhl.data.clean1$injstart.year[2289-1] = 2013

nhl.data.clean1$injstart.month[2512-1] = 11
nhl.data.clean1$injstart.day[2512-1] = 24
nhl.data.clean1$injstart.year[2512-1] = 2007

nhl.data.clean1$injstart.month[2660-1] = 10
nhl.data.clean1$injstart.day[2660-1] = 7
nhl.data.clean1$injstart.year[2660-1] = 2017

nhl.data.clean1$injstart.month[2718-1] = 12
nhl.data.clean1$injstart.day[2718-1] = 19
nhl.data.clean1$injstart.year[2718-1] = 2008

nhl.data.clean1$injstart.month[2864-1] = 10
nhl.data.clean1$injstart.day[2864-1] = 13
nhl.data.clean1$injstart.year[2864-1] = 2016

nhl.data.clean1$injstart.month[2973-1] = 10
nhl.data.clean1$injstart.day[2973-1] = 3
nhl.data.clean1$injstart.year[2973-1] = 2013

nhl.data.clean1$injstart.month[3280-1] = 1
nhl.data.clean1$injstart.day[3280-1] = 22
nhl.data.clean1$injstart.year[3280-1] = 2004

nhl.data.clean1$injstart.month[3460-1] = 1
nhl.data.clean1$injstart.day[3460-1] = 4
nhl.data.clean1$injstart.year[3460-1] = 2011

nhl.data.clean1$injstart.month[3573-1] = 10
nhl.data.clean1$injstart.day[3573-1] = 9
nhl.data.clean1$injstart.year[3573-1] = 2017

nhl.data.clean1$injstart.month[3689-1] = 10
nhl.data.clean1$injstart.day[3689-1] = 7
nhl.data.clean1$injstart.year[3689-1] = 2014

nhl.data.clean1$injstart.month[3860-1] = 12
nhl.data.clean1$injstart.day[3860-1] = 7
nhl.data.clean1$injstart.year[3860-1] = 2016

nhl.data.clean1$injstart.month[3434] = 10
nhl.data.clean1$injstart.day[3434] = 13
nhl.data.clean1$injstart.year[3434] = 2010

nhl.data.clean1$injstart.month[574] = 10
nhl.data.clean1$injstart.day[574] = 14
nhl.data.clean1$injstart.year[574] = 2013

nhl.data.clean1$injstart.month[1496] = 2
nhl.data.clean1$injstart.day[1496] = 17
nhl.data.clean1$injstart.year[1496] = 2018

nhl.data.clean1$injstart.month[1066] = 10
nhl.data.clean1$injstart.day[1066] = 11
nhl.data.clean1$injstart.year[1066] = 2017

nhl.data.clean1$injstart.month[578] = 10
nhl.data.clean1$injstart.day[578] = 5
nhl.data.clean1$injstart.year[578] = 2009

nhl.data.clean1$injstart.month[3197] = 5
nhl.data.clean1$injstart.day[3197] = 27
nhl.data.clean1$injstart.year[3197] = 2009

nhl.data.clean1$injstart.month[1578] = 12
nhl.data.clean1$injstart.day[1578] = 21
nhl.data.clean1$injstart.year[1578] = 2007

nhl.data.clean1$injstart.month[3005] = 3
nhl.data.clean1$injstart.day[3005] = 10
nhl.data.clean1$injstart.year[3005] = 2009

nhl.data.clean1$injstart.month[3076] = 3
nhl.data.clean1$injstart.day[3076] = 13
nhl.data.clean1$injstart.year[3076] = 2012

nhl.data.clean1$injstart.month[1042] = 12
nhl.data.clean1$injstart.day[1042] = 18
nhl.data.clean1$injstart.year[1042] = 2009

nhl.data.clean1$injstart.month[1032] = 1
nhl.data.clean1$injstart.day[1032] = 4
nhl.data.clean1$injstart.year[1032] = 2016

nhl.data.clean1$injstart.month[95] = 1
nhl.data.clean1$injstart.day[95] = 7
nhl.data.clean1$injstart.year[95] = 2012

nhl.data.clean1$injstart.month[2788] = 1
nhl.data.clean1$injstart.day[2788] = 12
nhl.data.clean1$injstart.year[2788] = 2009

nhl.data.clean1$injstart.month[3668] = 12
nhl.data.clean1$injstart.day[3668] = 7
nhl.data.clean1$injstart.year[3668] = 2008

nhl.data.clean1$injstart.month[2125] = 6
nhl.data.clean1$injstart.day[2125] = 2
nhl.data.clean1$injstart.year[2125] = 2013

nhl.data.clean1$injstart.month[1290] = 3
nhl.data.clean1$injstart.day[1290] = 19
nhl.data.clean1$injstart.year[1290] = 2008

nhl.data.clean1$injstart.month[236] = 2
nhl.data.clean1$injstart.day[236] = 25
nhl.data.clean1$injstart.year[236] = 2011

nhl.data.clean1$injstart.month[3873] = 12
nhl.data.clean1$injstart.day[3873] = 8
nhl.data.clean1$injstart.year[3873] = 2010

nhl.data.clean1$injstart.month[3802] = 1
nhl.data.clean1$injstart.day[3802] = 2
nhl.data.clean1$injstart.year[3802] = 2018

nhl.data.clean1$injstart.month[3380] = 10
nhl.data.clean1$injstart.day[3380] = 22
nhl.data.clean1$injstart.year[3380] = 2011

nhl.data.clean1$injstart.month[3871] = 11
nhl.data.clean1$injstart.day[3871] = 1
nhl.data.clean1$injstart.year[3871] = 2008

nhl.data.clean1$injstart.month[2998] = 10
nhl.data.clean1$injstart.day[2998] = 2
nhl.data.clean1$injstart.year[2998] = 2011

nhl.data.clean1$injstart.month[16] = 4
nhl.data.clean1$injstart.day[16] = 12
nhl.data.clean1$injstart.year[16] = 2009

nhl.data.clean1$injstart.month[3691] = 11
nhl.data.clean1$injstart.day[3691] = 2
nhl.data.clean1$injstart.year[3691] = 2008

nhl.data.clean1$injstart.month[3311] = 1
nhl.data.clean1$injstart.day[3311] = 6
nhl.data.clean1$injstart.year[3311] = 2011

nhl.data.clean1$injstart.month[806] = 11
nhl.data.clean1$injstart.day[806] = 10
nhl.data.clean1$injstart.year[806] = 2008

nhl.data.clean1$injstart.month[2995] = 10
nhl.data.clean1$injstart.day[2995] = 24
nhl.data.clean1$injstart.year[2995] = 2015

nhl.data.clean1$injstart.month[1412] = 11
nhl.data.clean1$injstart.day[1412] = 17
nhl.data.clean1$injstart.year[1412] = 2008

nhl.data.clean1$injstart.month[2355] = 1
nhl.data.clean1$injstart.day[2355] = 18
nhl.data.clean1$injstart.year[2355] = 2008

nhl.data.clean1$injstart.month[2995] = 10
nhl.data.clean1$injstart.day[2995] = 24
nhl.data.clean1$injstart.year[2995] = 2015

nhl.data.clean1$injstart.month[2397] = 12
nhl.data.clean1$injstart.day[2397] = 14
nhl.data.clean1$injstart.year[2397] = 2013

nhl.data.clean1$injstart.month[2733] = 1
nhl.data.clean1$injstart.day[2733] = 16
nhl.data.clean1$injstart.year[2733] = 2009

nhl.data.clean1$injstart.month[2206] = 11
nhl.data.clean1$injstart.day[2206] = 27
nhl.data.clean1$injstart.year[2206] = 2016

nhl.data.clean1$injstart.month[2219] = 1
nhl.data.clean1$injstart.day[2219] = 9
nhl.data.clean1$injstart.year[2219] = 2018

nhl.data.clean1$injstart.month[512] = 10
nhl.data.clean1$injstart.day[512] = 30
nhl.data.clean1$injstart.year[512] = 2014

nhl.data.clean1$injstart.month[70] = 4
nhl.data.clean1$injstart.day[70] = 4
nhl.data.clean1$injstart.year[70] = 2017

nhl.data.clean1$injstart.month[2989] = 11
nhl.data.clean1$injstart.day[2989] = 14
nhl.data.clean1$injstart.year[2989] = 2017

nhl.data.clean1$injstart.month[1147] = 2
nhl.data.clean1$injstart.day[1147] = 10
nhl.data.clean1$injstart.year[1147] = 2010

nhl.data.clean1$injstart.month[1741] = 11
nhl.data.clean1$injstart.day[1741] = 14
nhl.data.clean1$injstart.year[1741] = 2016

nhl.data.clean1$injstart.month[2902] = 3
nhl.data.clean1$injstart.day[2902] = 10
nhl.data.clean1$injstart.year[2902] = 2012

nhl.data.clean1$injstart.month[2192] = 1
nhl.data.clean1$injstart.day[2192] = 13
nhl.data.clean1$injstart.year[2192] = 2007

nhl.data.clean1$injstart.month[3369] = 1
nhl.data.clean1$injstart.day[3369] = 16
nhl.data.clean1$injstart.year[3369] = 2016


# check to make sure that none of the injury time spans are negative
start.date = toDate(nhl.data.clean1$injstart.year, nhl.data.clean1$injstart.month, nhl.data.clean1$injstart.day)
end.date = toDate(nhl.data.clean1$injend.year, nhl.data.clean1$injend.month, nhl.data.clean1$injend.day)
# check to make sure that none of the dates are negative
negative = (end.date - start.date) < 0
# check to make sure that dates look reasonable
nhl.data.clean1$DaysMissed = as.integer(end.date - start.date)
nhl.data.clean1$InjuryStartDate = start.date
nhl.data.clean1$InjuryEndDate = end.date






#edge case for missed games: "missed the last regular season game"
missedlastedgecasereg = grepl("Missed the last regular season|Missed the last game of the regular season", nhl.data.clean1$Injury)
missedlastedgecaseplay = grepl("first playoff game", nhl.data.clean1$Injury)

missedlastedgecasereg = replace(missedlastedgecasereg, missedlastedgecasereg==TRUE,1)
missedlastedgecasereg = replace(missedlastedgecasereg, missedlastedgecasereg==FALSE,0)
missedlastedgecaseplay = replace(missedlastedgecaseplay, missedlastedgecaseplay==TRUE,1)
missedlastedgecaseplay = replace(missedlastedgecaseplay, missedlastedgecaseplay==FALSE,0)

nhl.data.clean1$games.injured = nhl.data.clean1$games.injured + missedlastedgecasereg + missedlastedgecaseplay
# edge case: "Missed the last game of the regular season and Game 1, 2 and 3 of Round One against the Toronto Maple Leafs (lower body injury)."
nhl.data.clean1$games.injured[3934] = 4
# Missed Game 1, 2 and 3 of Round Two against the Anaheim Ducks (unknown).
nhl.data.clean1$games.injured[1114] = 3
# Missed all 4 games of Round 2 against the Colorado Avalanche and Game 1 of the Conference Final against the Edmonton Oilers (knee injury).
nhl.data.clean1$games.injured[1256] = 5
# Missed Game 2 of Round One against the Dallas Stars (head injury).
nhl.data.clean1$games.injured[3508] = 1
# Missed Game 3, 4 and 5 of the Eastern Conference Finals against the Pittsburgh Penguins (eye injury).
nhl.data.clean1$games.injured[2194] = 3
# Missed Game 4 of Round Two against the Detroit Red Wings (knee injury).
nhl.data.clean1$games.injured[2022] = 1
# Missed Game 4 of the Stanley Cup Finals against the Ottawa Senators (abdominal injury).
nhl.data.clean1$games.injured[2264] = 1
# Missed Game 5, 6 and 7 of Round One against the Vancouver Canucks (upper body injury).
nhl.data.clean1$games.injured[844] = 3
# Missed Game 6 and 7 of Round Two against Toronto (knee injury).
nhl.data.clean1$games.injured[539] = 2
# Missed Game 6 and 7 of Round Two against Toronto (back injury).
nhl.data.clean1$games.injured[2940] = 2
# Missed all 4 games of Round 2 against the Colorado Avalanche and Game 1 of the Conference Final against the Edmonton Oilers (knee injury).
nhl.data.clean1$games.injured[1256] = 5
#H1N1 cases
nhl.data.clean1$games.injured[578] = 2
nhl.data.clean1$games.injured[3422] = 1
# Missed 5 games of the Western Conference Finals against the Detroit Red Wings and games 1 and 2 of the Stanley Cup Finals against the Ottawa Senators (broken right hand).
nhl.data.clean1$games.injured[2263] = 7
# remove rows with visa issues as listed reason for missing games
nhl.data.clean1 = nhl.data.clean1[-grep("visa issues", nhl.data.clean1$Injury),]

# remove all rows with "personal" listed as injury
nhl.data.clean1 = nhl.data.clean1[-grep("personal", nhl.data.clean1$Injury),]


# categorize general injuries - 45 categories
nhl.data.clean1$GeneralInjury = nhl.data.clean1$InjuryType
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("eye|orbital", nhl.data.clean1$GeneralInjury), "eye")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("head", nhl.data.clean1$GeneralInjury), "head")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("face|nose|nasal|cheek|facial", nhl.data.clean1$GeneralInjury), "face")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("mouth|jaw|oral", nhl.data.clean1$GeneralInjury), "mouth")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("neck", nhl.data.clean1$GeneralInjury), "neck")

nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("shoulder", nhl.data.clean1$GeneralInjury), "shoulder")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("upper body|torso", nhl.data.clean1$GeneralInjury), "upper body")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("hand", nhl.data.clean1$GeneralInjury), "hand")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("finger|thumb|knuckle", nhl.data.clean1$GeneralInjury), "finger")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("elbow", nhl.data.clean1$GeneralInjury), "elbow")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("bicep|tricep|muscle", nhl.data.clean1$GeneralInjury), "muscle")

nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("wrist", nhl.data.clean1$GeneralInjury), "wrist")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("arm", nhl.data.clean1$GeneralInjury), "arm")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("back|sacrum", nhl.data.clean1$GeneralInjury), "back")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("collarbone|collar bone|clavicle", nhl.data.clean1$GeneralInjury), "collarbone")

nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("chest|stern", nhl.data.clean1$GeneralInjury), "chest")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("abdom|oblique", nhl.data.clean1$GeneralInjury), "abdominal")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("hip", nhl.data.clean1$GeneralInjury), "hip")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("rib", nhl.data.clean1$GeneralInjury), "rib")

nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("lower body", nhl.data.clean1$GeneralInjury), "lower body")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("knee|ACL|MCL|acl|mcl", nhl.data.clean1$GeneralInjury), "knee")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("sick|flu|cold|virus|H1N1|viral|pneumonia|mono|throat|sinus|illness|food|poison|mumps|rash|leukemia", nhl.data.clean1$GeneralInjury), "cold/virus")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("leg|shin", nhl.data.clean1$GeneralInjury), "leg")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("quad", nhl.data.clean1$GeneralInjury), "quad")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("calf|calves|charley horse", nhl.data.clean1$GeneralInjury), "calf")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("thigh", nhl.data.clean1$GeneralInjury), "thigh")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("groin|cervi", nhl.data.clean1$GeneralInjury), "groin")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("hamstring", nhl.data.clean1$GeneralInjury), "hamstring")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("tibia|fibula", nhl.data.clean1$GeneralInjury), "tibia/fibula")


nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("foot|heel", nhl.data.clean1$GeneralInjury), "foot")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("toe", nhl.data.clean1$GeneralInjury), "toe")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("ankle", nhl.data.clean1$GeneralInjury), "ankle")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("achilles", nhl.data.clean1$GeneralInjury), "achilles")


nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("personal", nhl.data.clean1$GeneralInjury), "personal")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("concussion|consussion", nhl.data.clean1$GeneralInjury), "concussion")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("pect", nhl.data.clean1$GeneralInjury), "pectoral")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("append", nhl.data.clean1$GeneralInjury), "appendicitis")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("heart|colon|stomach", nhl.data.clean1$GeneralInjury), "internals")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("sore", nhl.data.clean1$GeneralInjury), "sore")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("hernia", nhl.data.clean1$GeneralInjury), "hernia")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("spleen", nhl.data.clean1$GeneralInjury), "spleen")
nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("tailbone", nhl.data.clean1$GeneralInjury), "tailbone")


nhl.data.clean1$GeneralInjury = replace(nhl.data.clean1$GeneralInjury, grep("various|blood clots|dizzy|cyst|dehydration", nhl.data.clean1$GeneralInjury), "other")


#reduce number of injury types even more (for visulization purposes) (10 categories)
nhl.data.clean1$ReducedInjuryTypes = nhl.data.clean1$GeneralInjury
nhl.data.clean1$ReducedInjuryTypes = replace(nhl.data.clean1$ReducedInjuryTypes, grep("face|head|neck|ear|eye", nhl.data.clean1$ReducedInjuryTypes), "head/neck/face")
nhl.data.clean1$ReducedInjuryTypes = replace(nhl.data.clean1$ReducedInjuryTypes, grep("upper|shoulder", nhl.data.clean1$ReducedInjuryTypes), "upper body")
nhl.data.clean1$ReducedInjuryTypes = replace(nhl.data.clean1$ReducedInjuryTypes, grep("abdominal|back|chest|collarbone|mid|spleen|rib", nhl.data.clean1$ReducedInjuryTypes), "mid body")
nhl.data.clean1$ReducedInjuryTypes = replace(nhl.data.clean1$ReducedInjuryTypes, grep("groin|tailbone|hip|lower", nhl.data.clean1$ReducedInjuryTypes), "lower body")
nhl.data.clean1$ReducedInjuryTypes = replace(nhl.data.clean1$ReducedInjuryTypes, grep("arm|hand|wrist|finger|elbow", nhl.data.clean1$ReducedInjuryTypes), "arm/hand")
nhl.data.clean1$ReducedInjuryTypes = replace(nhl.data.clean1$ReducedInjuryTypes, grep("tailbone|calf|knee|leg|tibia/fibula|thigh|hamstring|quad", nhl.data.clean1$ReducedInjuryTypes), "leg")
nhl.data.clean1$ReducedInjuryTypes = replace(nhl.data.clean1$ReducedInjuryTypes, grep("achilles|ankle", nhl.data.clean1$ReducedInjuryTypes), "foot")

nhl.data.clean1$ReducedInjuryTypes = replace(nhl.data.clean1$ReducedInjuryTypes, grep("cold/virus|illness", nhl.data.clean1$ReducedInjuryTypes), "illness")
nhl.data.clean1$ReducedInjuryTypes = replace(nhl.data.clean1$ReducedInjuryTypes, grep("concussion", nhl.data.clean1$ReducedInjuryTypes), "concussion")
nhl.data.clean1$ReducedInjuryTypes = replace(nhl.data.clean1$ReducedInjuryTypes, grep("append|hernia|internals|muscle|other|hernia|thyroid|other|unknown|sore|rest|personal", nhl.data.clean1$ReducedInjuryTypes), "other")

# unreduced injuries by team
library(ggplot2)
ggplot(data=na.omit(nhl.data.clean1), aes(x = TeamName, fill=unlist(GeneralInjury))) + geom_bar() + theme(axis.text.x = element_text(angle = 45, hjust = 1, size=6)) + labs(title="Frequency of Tyes of Injuries per NHL Team",x = "Team", y = "Frequency")
ggplot(data=na.omit(nhl.data.clean1), aes(x = TeamName, fill=unlist(ReducedInjuryTypes))) + geom_bar() + theme(axis.text.x = element_text(angle = 45, hjust = 1, size=6)) + labs(title="Frequency of Tyes of Injuries per NHL Team",x = "Team", y = "Frequency") + scale_fill_discrete("Injury Type")

# extra - get unique player identifier by merging first and last names
nhl.data.clean1$FirstLast = paste(nhl.data.clean1$Firstname, nhl.data.clean1$Lastname, sep=" ")

# reset indices one last time for this dataset
for(i in 1:nrow(nhl.data.clean1)){
  nhl.data.clean1$Index[i] = i
}
# First Injury per Player
t.first <- nhl.data.clean1[match(unique(nhl.data.clean1$FirstLast), nhl.data.clean1$FirstLast),]$Index
previously.injured = rep(1,nrow(nhl.data.clean1))
previously.injured[t.first] = 0
nhl.data.clean1$PreviouslyInjured = previously.injured



# get days since last injury
healthy.duration = rep(NA, nrow(nhl.data.clean1))

for(i in 1:(nrow(nhl.data.clean1)-1)){
  if((nhl.data.clean1$Lastname[i] == nhl.data.clean1$Lastname[i+1]) && (nhl.data.clean1$Firstname[i] == nhl.data.clean1$Firstname[i+1])){
    healthy.duration[i] = nhl.data.clean1$InjuryStartDate[i+1] - nhl.data.clean1$InjuryEndDate[i]
  }
}
nhl.data.clean1$HealthyDuration = healthy.duration





####### FORGOT TO INCLUDE FLAMES DATA IN THE DATASET - FILTERING IT HERE BEFORE MERING #######
FlamesData.clean2 = read.table("~/Desktop/CMU/36-490/NHL-Research/Clean-Data/FlamesData_V1.txt", sep="\t")
FlamesData.clean2$InjuryStartDate = as.Date(FlamesData.clean2$InjuryStartDate / 86400, origin = "1970-01-01")
FlamesData.clean2$InjuryEndDate = as.Date(FlamesData.clean2$InjuryEndDate / 86400, origin = "1970-01-01")

nhl.data.clean1 = merge(nhl.data.clean1, FlamesData.clean2, all=TRUE)
# fix team name at end
nhl.data.clean1$City[which(nhl.data.clean1$TeamName == "JERSEYDEVILS")] = "NEW JERSEY"
nhl.data.clean1$TeamName[which(nhl.data.clean1$TeamName == "JERSEYDEVILS")] = "DEVILS"

write.table(as.matrix(nhl.data.clean1), "Clean-Data/NHL_Clean_V15.txt", sep="\t")


```

```{r message=FALSE, warning=FALSE}
teamnames = unique(nhl.data.clean1$TeamName)[1:31]

bruins.subset = subset(nhl.data.clean1, TeamName == "BRUINS")
ggplot(bruins.subset[which(bruins.subset$injstart.year > 2016),]) + 
  geom_point(aes(x=InjuryStartDate,y=Lastname), col="red") + 
  geom_point(aes(x=InjuryEndDate,y=Lastname), col="green") + 
  geom_segment(aes(x=InjuryStartDate,y=Lastname, xend=InjuryEndDate, yend=Lastname)) + 
  labs(
    title="Bruins' Injury History since 2016",
    x="Time (Year)",
    y="Player"
  ) 
```


## Beginning Multi-State Modeling with R msm package

MSM manual: https://cran.r-project.org/web/packages/msm/vignettes/msm-manual.pdf

```{r warning=FALSE}
library(msm)

# begin by sorting data by player and chronological order
nhl.data.ordered = nhl.data.clean1[with(nhl.data.clean1, order(FirstLast, InjuryStartDate)),]
# need to duplicate data points in order to classify date into injury status (ie. injury start date -> injured = 1, injury end date -> injured = 2)
nhl.data.double = nhl.data.ordered[rep(1:nrow(nhl.data.ordered),each=2),] 

nhl.data.double$InjuryIndicator = rep(c(1,2), nrow(nhl.data.double) / 2)
# column for date of entry
date = nhl.data.double$InjuryStartDate
for(i in seq(from=2, to=nrow(nhl.data.double), by=2)){
#  stuff, such as
  date[i] = nhl.data.double$InjuryEndDate[i]
}
nhl.data.double$InjuryStateDate = date
nhl.data.double$FirstLast = paste(nhl.data.double$Firstname, nhl.data.double$Lastname, sep=" ")

# time variable for years after 1/1/2000
nhl.data.double$YearsSince2000 = as.integer(nhl.data.double$InjuryStateDate - toDate(2000,1,1)) / 365

# Set injury type for duplicated Injury to NA if they are not injured
nhl.data.double$ReducedInjuryTypes[seq(2,nrow(nhl.data.double), by=2)] = NA
nhl.data.double$GeneralInjury[seq(2,nrow(nhl.data.double), by=2)] = NA
nhl.data.double$ReducedInjuryTypes = as.character(nhl.data.double$ReducedInjuryTypes)
nhl.data.double$GeneralInjury = as.character(nhl.data.double$ReducedInjuryTypes)

for(i in 1:nrow(nhl.data.double)){
  nhl.data.double$Index[i] = i
}
# A useful way to summarise multi-state data is as a frequency table of pairs of consecutive states.
# counts over all individuals, for each state r and s, the number of times an individual had an
# observation of state r followed by an observation of state s. The function statetable.msm can
# be used to produce such a table, as follows

# state table of MSM for Penguins players
statetable.msm(InjuryIndicator, FirstLast, data=subset(nhl.data.double, TeamName == "PENGUINS"))
# set Q equal to results of statetable.msm
Q = matrix(c(-.3,.3,.3,-.3), nrow=2,ncol=2, dimnames=list(from=1:2,to=1:2))
# basic bidirectional model of injury mapping
msm.null = msm(InjuryIndicator ~ YearsSince2000, subject=FirstLast, data = nhl.data.double, 
               qmatrix = Q, deathexact = NULL, exacttimes=TRUE)

msm.previnjured = msm(InjuryIndicator ~ YearsSince2000, subject=FirstLast, data = nhl.data.double, 
               qmatrix = Q, deathexact = NULL, exacttimes=TRUE, covariates = ~ PreviouslyInjured)

# interpretation example: 6x more likely one will get injured with general injury illness than a leg injury
msm.previnjured.injury = msm(InjuryIndicator ~ YearsSince2000, subject=FirstLast, data = nhl.data.double, 
               qmatrix = Q, deathexact = NULL, exacttimes=TRUE, 
               covariates = list("1-2" = ~ PreviouslyInjured +  GeneralInjury, "2-1" = ~ PreviouslyInjured))

plot(msm.previnjured)

# we calculate the observed expected numbers and percentages at two-yearly intervals up to 18 years after 2000
# goodness of fit model
prevalence.msm(msm.previnjured, times = seq(0, 18, 2))
totlos.msm(msm.previnjured.injury, start=1,tot=20)
```


$\textbf{NOTES:}$


EDA:
- dist. of games/days missed
- dist of days/games missed conditioned on injury typed
- conditioned on team

df = df %/% group_by(player_id) %>% arrange(inj.date) %>% 
  mutate(last_inj = lag(inj_data, 1), last_inj_type = lag(inj_type, 1),  next_inj_type = lead(inj_type, 1), ...)
  
  
For next meeting with Sam (week of 3/10):
1. EDA on injury recurrence (ie. subcat. muscle/ligament/bone, upper/lower/head, etc.)
2. EDA on time of injury/survival models variables
3. Multistate and Survival Modeling - look at coefficients
4. think of how to model injury recurrence

- EDA on full dataset on days elapsed vs. type of injury, position, 
- injury recurrence - probability of having another injury of some other type
  - muscle/ligament/bone/etc.
- Understand model implications and correct use case (ie. assumptions that are broken when running a test)
- presenting a better model is a better fit for the problem (multistate vs. survival analysis)

Tidyr - gather/spread
https://cran.r-project.org/web/packages/tidyr/tidyr.pdf

- only have data modeled after a player has alrady been injured
- lubridate - dates